#include <avr/sleep.h>
#include <avr/pgmspace.h>

// ATtiny85 Default Pin Names
#define IO_PIN_0 PB0   // Physical pin 5
#define IO_PIN_1 PB1   // Physical pin 6 (LED_BUILTIN)
#define IO_PIN_2 PB2   // Physical pin 7 (INT0)
#define IO_PIN_3 PB3   // Physical pin 2
#define IO_PIN_4 PB4   // Physical pin 3 
#define IO_PIN_5 PB5   // Physical pin 1 (RESET, avoid using unless fuse-modified)

// Functional Pin Assignments
#define TX_PIN IO_PIN_3              // 433MHz Transmitter Data Pin
#define STATUS_LED IO_PIN_1          // Onboard LED for Transmission Indication
#define SIGNAL_1_BTN IO_PIN_2        // Emits signal 1 if this pin is LOW
#define SIGNAL_2_BTN IO_PIN_4        // Emits signal 2 if this pin is LOW
#define SIGNAL_3_BTN IO_PIN_0        // Emits signal 3 if this pin is LOW

// Signal Data (Stored in Flash to save RAM)
const int16_t signal_data_1[] PROGMEM = {4125,-9928,129,-922,65,-954,197,-98,795,-266,65,-66,131,-300,531,-100,499,-132,99,-100,38515,-9766,163,-1618,161,-98,427,-100,97,-334,397,-100,361,-164,163,-132,199,-66,567,-200,299,-132,227,-100,263,-68,297,-100,4317,-6238,99,-3540,65,-262,65,-730,165,-828,295,-100,99,-134,65,-66,131,-298,395,-130,527,-166,265,-66,199,-134,529,-132,67,-100,891,-100,4651,-10006,195,-98,261,-162,99,-460,689,-166,461,-398,197,-296,197,-100,333,-296,801,-12388,129,-1020,163,-130,161,-164,97,-198,459,-66,589,-98,163,-66,15709,-11116,65,-1484,329,-134,99,-100,201,-100,135,-100,199,-66,169,-336,231,-232,199,-166,229,-132,469,-132,925,-98,11353,-9756,193,-862,363,-232,99,-398,595,-404,65,-234,499,-362,16315,-9788,133,-1084,231,-68,429,-100,131,-168,97,-100,199,-332,431,-100,165,-100,1161,-66,297,-166,6965,-9914,327,-1960,65,-98,197,-100,669,-98,131,-132,131,-132,853,-230,229,-396,1089,-134,4895,-4284,65,-5600,65,-864,163,-300,197,-294,195,-98,361,-130,393,-132,65,-66,197,-98,401,-134,627,-100,461,-68,231,-166,2567,-100,3185,-4504,133,-332,263,-232,131,-332,65,-66,363,-396,267,-100,365,-234,897,-232,163,-100,229,-328,229,-198,1187,-954,4009,-940,713,-914,757,-900,5713,-896,7385,-842,1639,-1648,4121,-21496,727,-1032,2519,-132,1255,-990,701,-968,707,-910,5723,-876,7369,-872,1621,-1670,4097,-21472,751,-1012,2551,-132,1289,-950,717,-960,703,-906,5735,-866,7379,-842,1643,-1644,4129,-21480,561,-3758,1389,-976,673,-990,683,-986,5651,-886,7373,-840,1637,-1670,4111,-21492,633,-3746,1323,-950,727,-932,741,-876,5729,-872,7387,-848,1645,-1656,4107,-21484,667,-3182,1449,-970,701,-940,691,-954,5703,-886,7371,-824,1657,-1642,4133,-21490,727,-1030,3947,-948,729,-932,703,-934,5697,-876,7395,-852,1633,-1646,4113,-7473};
const int16_t signal_data_2[] PROGMEM = {1642,-490,97,-890,65,-632,97,-526,229,-100,1283,-166,699,-98,165,-66,165,-198,765,-2524,265,-134,363,-98,297,-66,393,-164,7729,-7080,65,-66,65,-434,163,-436,263,-98,859,-232,295,-262,195,-622,131,-164,65,-98,195,-724,627,-132,229,-98,457,-100,427,-6998,631,-98,1161,-166,65,-1598,397,-132,331,-298,295,-100,2355,-98,2953,-8214,129,-1450,65,-764,65,-1592,397,-68,397,-134,465,-1890,99,-200,233,-570,295,-100,827,-66,265,-134,331,-66,2719,-8194,97,-366,65,-4994,163,-330,131,-962,165,-298,163,-132,923,-98,495,-98,459,-66,99,-164,391,-166,259,-166,1869,-66,8549,-8076,229,-66,461,-100,593,-98,99,-1480,65,-732,461,-68,529,-66,799,-100,529,-100,7441,-7240,165,-262,129,-492,591,-198,361,-496,65,-166,99,-200,263,-200,65,-990,65,-98,131,-166,195,-102,333,-134,333,-66,889,-134,4921,-13326,197,-168,165,-134,163,-758,99,-164,97,-522,97,-66,459,-166,231,-100,533,-100,429,-98,8311,-8212,729,-496,363,-232,99,-66,163,-134,265,-298,531,-166,331,-132,395,-15992,131,-66,97,-100,361,-330,65,-794,163,-130,97,-1884,363,-66,327,-132,261,-100,327,-132,129,-98,8049,-7252,65,-98,97,-564,959,-332,163,-66,97,-100,263,-130,197,-130,131,-1806,1345,-164,555,-66,4043,-7686,199,-492,165,-7340,429,-130,491,-100,293,-66,163,-198,163,-98,325,-198,163,-132,231,-428,263,-460,459,-66,585,-430,3395,-16412,425,-98,261,-98,99,-198,165,-658,459,-66,165,-196,99,-262,131,-100,197,-164,11549,-3524,65,-4716,331,-198,463,-330,397,-496,165,-132,597,-66,233,-232,195,-68,9809,-6608,99,-132,99,-564,65,-660,197,-66,99,-66,163,-100,65,-66,197,-822,197,-564,65,-66,195,-460,163,-298,199,-166,201,-134,561,-66,263,-98,229,-98,229,-64,1515,-66,5489,-7196,97,-266,197,-562,725,-100,361,-100,231,-168,67,-66,133,-768,97,-166,65,-132,97,-230,7839,-12156,199,-200,99,-166,267,-100,197,-166,263,-630,131,-658,97,-66,595,-166,297,-66,635,-100,3025,-7928,97,-66,99,-1988,97,-5640,265,-264,65,-130,229,-322,199,-1162,161,-164,65,-364,295,-592,491,-66,461,-132,295,-132,2015,-7586,163,-132,131,-198,395,-134,163,-166,231,-200,65,-698,63,-100,197,-164,329,-1000,329,-66,267,-136,333,-134,163,-68,333,-66,401,-8320,165,-66,131,-166,133,-164,561,-200,65,-66,365,-726,65,-132,163,-132,99,-66,97,-98,99,-98,197,-398,329,-134,497,-134,8577,-6522,131,-200,495,-692,165,-66,1027,-500,99,-100,65,-1418,689,-100,6101,-8436,99,-132,97,-1156,63,-66,65,-3674,99,-200,163,-96,163,-360,131,-134,435,-100,665,-98,365,-300,165,-166,195,-100,97,-164,427,-464,591,-166,9321,-5976,99,-394,99,-832,99,-200,65,-268,131,-66,431,-132,133,-66,1259,-230,12245,-3142,2701,-9782,817,-846,4185,-880,819,-854,825,-844,821,-1702,817,-852,851,-1672,845,-3362,851,-3324,873,-826,1671,-856,3363,-18986,687,-160,363,-1128,163,-432,97,-330,199,-974,1553,-948,1585,-908,1633,-878,5019,-900,835,-852,4177,-846,859,-842,813,-852,831,-1710,825,-844,851,-1648,845,-3358,865,-3358,843,-812,1699,-824,3365,-18982,1973,-232,625,-1054,663,-940,1557,-982,1581,-906,763,-1746,5013,-934,795,-872,4179,-850,829,-846,843,-840,819,-1704,839,-844,837,-1672,831,-3362,843,-3350,839,-860,1665,-864,3347,-18972,1953,-266,587,-1066,667,-976,1541,-960,1593,-910,749,-918,799,-876,4175,-944,787,-878,4159,-848,835,-846,839,-854,819,-1702,843,-848,807,-1712,809,-3376,841,-3364,843,-814,1695,-858,3359,-18984,1945,-232,1449,-1860,1553,-950,1587,-942,3281,-900,3319,-924,805,-852,4185,-882,815,-846,827,-844,843,-1680,845,-820,837,-1708,827,-3354,865,-3324,875,-818,1673,-856,3345,-18986,1965,-232,2339,-960,1559,-958,1575,-936,2453,-1740,3321,-914,807,-886,4159,-870,837,-842,825,-842,841,-1678,837,-852,843,-1668,837,-3352,867,-3352,833,-850,1663,-856,3359,-18986,1987,-134,727,-950,3273,-916,1621,-876,793,-886,2471,-906,2465,-942,817,-842,4187,-856,843,-848,805,-854,853,-1672,843,-850,841,-1676,811,-3374,841,-3368,845,-814,1697,-822,3375,-18986,2003,-134,727,-952,729,-942,1593,-916,1613,-912,775,-2568,787,-870,2495,-914,839,-848,4169,-878,803,-852,851,-844,831,-1668,861,-844,815,-1702,839,-3370,843,-3334,855,-844,1669,-852,3355,-5386};
const int16_t signal_data_3[] PROGMEM = {4125,-9928,129,-922,65,-954,197,-98,795,-266,65,-66,131,-300,531,-100,499,-132,99,-100,38515,-9766,163,-1618,161,-98,427,-100,97,-334,397,-100,361,-164,163,-132,199,-66,567,-200,299,-132,227,-100,263,-68,297,-100,4317,-6238,99,-3540,65,-262,65,-730,165,-828,295,-100,99,-134,65,-66,131,-298,395,-130,527,-166,265,-66,199,-134,529,-132,67,-100,891,-100,4651,-10006,195,-98,261,-162,99,-460,689,-166,461,-398,197,-296,197,-100,333,-296,801,-12388,129,-1020,163,-130,161,-164,97,-198,459,-66,589,-98,163,-66,15709,-11116,65,-1484,329,-134,99,-100,201,-100,135,-100,199,-66,169,-336,231,-232,199,-166,229,-132,469,-132,925,-98,11353,-9756,193,-862,363,-232,99,-398,595,-404,65,-234,499,-362,16315,-9788,133,-1084,231,-68,429,-100,131,-168,97,-100,199,-332,431,-100,165,-100,1161,-66,297,-166,6965,-9914,327,-1960,65,-98,197,-100,669,-98,131,-132,131,-132,853,-230,229,-396,1089,-134,4895,-4284,65,-5600,65,-864,163,-300,197,-294,195,-98,361,-130,393,-132,65,-66,197,-98,401,-134,627,-100,461,-68,231,-166,2567,-100,3185,-4504,133,-332,263,-232,131,-332,65,-66,363,-396,267,-100,365,-234,897,-232,163,-100,229,-328,229,-198,1187,-954,4009,-940,713,-914,757,-900,5713,-896,7385,-842,1639,-1648,4121,-21496,727,-1032,2519,-132,1255,-990,701,-968,707,-910,5723,-876,7369,-872,1621,-1670,4097,-21472,751,-1012,2551,-132,1289,-950,717,-960,703,-906,5735,-866,7379,-842,1643,-1644,4129,-21480,561,-3758,1389,-976,673,-990,683,-986,5651,-886,7373,-840,1637,-1670,4111,-21492,633,-3746,1323,-950,727,-932,741,-876,5729,-872,7387,-848,1645,-1656,4107,-21484,667,-3182,1449,-970,701,-940,691,-954,5703,-886,7371,-824,1657,-1642,4133,-21490,727,-1030,3947,-948,729,-932,703,-934,5697,-876,7395,-852,1633,-1646,4113,-21510,827,-822,4119,-840,801,-872,813,-826,5741,-848,7427,-832,1635,-1678,4099,-21486,791,-900,4071,-886,763,-868,805,-838,5763,-846,7397,-848,1633,-1658,4121,-21494,809,-848,4125,-810,823,-836,843,-812,5771,-832,7425,-810,1671,-1650,4093,-21494,793,-908,4051,-880,791,-868,773,-872,5749,-848,7421,-816,1645,-1670,4093,-21480,845,-866,4087,-848,783,-860,807,-842,5755,-836,7431,-812,1673,-1636,4121,-21470,853,-838,4125,-792,839,-844,811,-818,5769,-840,7431,-810,1639,-1682,4097,-21490,789,-906,4081,-848,793,-868,773,-878,5733,-872,7387,-844,1637,-1646,4109,-21500,823,-842,4127,-816,835,-808,851,-818,5769,-832,7423,-812,1671,-1638,4123,-21466,817,-900,4049,-888,765,-872,807,-840,5733,-880,7391,-848,1635,-1650,4123,-22498,843,-822,4129,-820,837,-840,811,-814,5791,-808,7423,-848,1637,-1648,4147,-21472,793,-906,4037,-892,765,-904,777,-844,5757,-840,7405,-850,1635,-1644,4107,-21508,819,-820,4133,-832,809,-844,817,-844,5759,-842,7385,-846,1631,-1682,4087,-21496,811,-870,4091,-834,807,-844,807,-850,5761,-844,7399,-844,1637,-1644,4113,-21474,823,-820,4147,-814,835,-810,851,-816,5771,-828,7429,-808,1637,-1650,4139,-21466,817,-846,4113,-810,821,-838,849,-818,5745,-858,7407,-810,1643,-1644,4123,-21492,817,-844,4123,-810,821,-836,809,-844,5779,-826,7407,-812,1675,-1616,4129,-21478,813,-870,4079,-878,757,-896,771,-872,5735,-868,7393,-810,1639,-1678,4121,-21454,841,-810,4149,-810,819,-836,811,-850,5739,-858,7409,-808,1671,-1650,4097,-21458,821,-870,4079,-880,757,-898,773,-876,5733,-834,7421,-808,1667,-1626,4137,-21460,831,-838,4127,-824,803,-846,831,-806,5785,-830,7409,-810,1671,-1616,4135,-21478,759,-966,3969,-980,687,-928,735,-908,5707,-896,7363,-838,1629,-1676,4093,-21494,791,-900,4043,-916,727,-902,773,-874,5737,-868,7385,-844,1609,-1682,4105,-21462,515,-3878,99,-264,129,-496,101,-968,741,-930,5645,-910,7397,-822,1635,-1652,4111,-21464,793,-958,3983,-952,717,-922,737,-904,5695,-896,7371,-844,1637,-1644,4127,-21448,761,-996,3979,-950,723,-898,771,-874,5705,-900,7361,-872,1601,-1674,4099,-159444,167,-2784,99,-898,235,-364,231,-434,167,-704,197,-98,597,-296,299,-132,2869,-5110,63,-230,97,-532,131,-562,97,-98,97,-298,129,-2276,165,-400,233,-168,65,-232,231,-394,529,-66,887,-394,721,-98,1085,-8212,65,-930,99,-262,63,-1150,99,-998,397,-328,361,-230,365,-296,361,-66,393,-66,261,-66,291,-66,391,-132,787,-66,753,-98,261,-64,14833,-4136,65,-100,131,-558,65,-2248,133,-1292,97,-1294,131,-198,229,-726,197,-396,697,-164,231,-100,165,-166,495,-164,689,-164,491,-66,3961,-12310,433,-434,527,-630,65,-166,1861,-66,363,-66,391,-132,4419,-9254,65,-130,163,-1806,97,-166,65,-794,195,-164,63,-856,299,-264,233,-298,659,-132,791,-66,97,-100,1063,-66,8293,-4386,97,-1210,65,-1020,231,-2446,67,-266,133,-100,165,-100,131,-532,65,-232,233,-264,197,-166,2757,-66,6535,-4052,99,-132,65,-200,231,-3044,65,-66,329,-132,131,-66,131,-332,133,-530,729,-98,2163,-134,8647,-5182,99,-3648,131,-730,65,-764,265,-364,133,-336,231,-166,893,-100,497,-132,727,-66,12715,-1408,65,-2906,163,-292,195,-232,67,-66,129,-564,263,-432,231,-960,199,-100,333,-100,263,-100,199,-66,299,-66,1257,-98,1259,-5774,99,-894,97,-998,133,-1366,197,-100,201,-98,133,-132,565,-98,131,-100,65,-296,931,-66,8387,-10234,199,-66,133,-132,67,-100,131,-132,433,-628,561,-68,265,-68,9149,-2144,99,-3514,65,-4020,67,-396,99,-98,97,-532,65,-168,133,-332,65,-164,97,-166,133,-134,533,-100,8431,-3752,133,-1132,199,-1126,163,-260,131,-852,65,-1316,65,-664,99,-66,65,-134,65,-332,399,-598,133,-266,131,-132,1159,-100,363,-100,397,-232,497,-100,33189,-4604,65,-3196,99,-66,297,-494,131,-460,165,-130,527,-66,365,-68,791,-66,523,-232,32435,-7506,131,-2162,397,-132,199,-600,131,-664,97,-66,231,-66,267,-132,433,-66,301,-198,9421,-5188,163,-2306,65,-2148,231,-424,229,-132,131,-394,65,-330,759,-98,785,-66,225,-164,1479,-66,721,-8718,231,-1522,199,-2012,297,-566,267,-134,67,-130,195,-430,65,-100,731,-134,231,-236,1727,-366,497,-3756,99,-1034,199,-98,131,-262,131,-1124,65,-1484,97,-1524,131,-100,133,-626,197,-64,65,-64,65,-296,555,-100,14203,-4020,65,-4752,67,-100,131,-168,233,-164,99,-100,231,-368,99,-200,263,-132,1029,-66,9431,-3926,63,-494,165,-168,99,-956,393,-100,393,-132,65,-266,199,-500,1361,-132,333,-100,365,-68,5909,-8582,65,-992,131,-1452,99,-1524,131,-68,197,-492,99,-98,163,-166,197,-424,1441,-98,787,-66,1675,-436,199,-68,131,-3120,131,-132,65,-896,497,-166,329,-132,525,-100,767,-3978,97,-598,65,-698,99,-1826,131,-1130,99,-168,365,-68,363,-98,201,-100,329,-100,263,-66,231,-132,3499,-8376,97,-134,65,-334,99,-166,99,-1960,97,-764,131,-168,167,-200,199,-134,99,-232,329,-364,165,-100,2429,-100,4043,-8498,97,-1358,97,-200,99,-1032,163,-430,597,-102,265,-298,3777,-66,6413,-200,103,-2188,65,-1224,233,-232,99,-132,99,-1062,99,-800,133,-370,131,-530,463,-168,65,-68,295,-366,1759,-66,329,-100,5919,-8404,163,-194,131,-130,65,-658,165,-196,65,-1120,131,-1396,463,-98,163,-334,99,-232,131,-266,759,-98,493,-98,625,-66,597,-4172,63,-132,131,-922,163,-258,97,-956,131,-490,163,-394,631,-430,131,-198,721,-64,325,-6034,131,-860,299,-166,67,-164,67,-300,199,-466,99,-168,65,-434,99,-1164,65,-132,231,-232,565,-100,131,-100,165,-134,165,-166,2615,-13678,165,-334,233,-100,263,-2350,331,-98,231,-66,599,-728,65,-66,857,-66,1351,-98,3791,-8366,131,-336,65,-366,363,-556,395,-166,263,-334,329,-100,133,-98,1515,-420,99,-2652,65,-1234,99,-830,133,-232,163,-794,65,-920,65,-1250,99,-696,163,-132,131,-132,97,-66,463,-66,3601,-64};

const int16_t* selected_signal;
uint16_t signal_length;
uint16_t pointer = 0;

void setup() {
    // Configure Pins
    pinMode(TX_PIN, OUTPUT);
    pinMode(STATUS_LED, OUTPUT);
    pinMode(SIGNAL_1_BTN, INPUT_PULLUP);
    pinMode(SIGNAL_2_BTN, INPUT_PULLUP);
    pinMode(SIGNAL_3_BTN, INPUT_PULLUP);

    // Ensure TX & Antenna are Off
    digitalWrite(TX_PIN, LOW);
    digitalWrite(STATUS_LED, LOW);

    delay(10); // Give enough time for the tx to power on

    bool signal_selected = false;

    while (!signal_selected)
    {
        if (digitalRead(SIGNAL_1_BTN) == LOW) {
            selected_signal = signal_data_1;
            signal_length = sizeof(signal_data_1) / sizeof(signal_data_1[0]);

            blink(200, 1);

            signal_selected = true;
        } else if (digitalRead(SIGNAL_2_BTN) == LOW) {
            selected_signal = signal_data_2;
            signal_length = sizeof(signal_data_2) / sizeof(signal_data_2[0]);

            blink(200, 2);

            signal_selected = true;
        } else if (digitalRead(SIGNAL_3_BTN) == LOW) {
            selected_signal = signal_data_3;
            signal_length = sizeof(signal_data_3) / sizeof(signal_data_3[0]);

            blink(200, 3);

            signal_selected = true;
        }
    }

    digitalWrite(STATUS_LED, LOW);
}

void blink(int interval, int times) {
    for (int i = 0; i < times; i++) {
        digitalWrite(STATUS_LED, HIGH);
        delay(interval);
        digitalWrite(STATUS_LED, LOW);
        delay(interval);
    }
}

void loop() {
    // Transmit the signal with LED indication
      int16_t val = pgm_read_word_near(selected_signal + pointer);

      if (++pointer >= signal_length) {
        pointer = 0;  // Reset pointer when end of signal is reached
      }

      if (val > 0) {
          digitalWrite(TX_PIN, HIGH);
          digitalWrite(STATUS_LED, HIGH);
      } else {
          digitalWrite(TX_PIN, LOW);
          digitalWrite(STATUS_LED, LOW);
      }

      smartDelay(abs(val));  // Handle long delays properly
}

// Function to handle both short and long delays
void smartDelay(uint16_t us) {
    if (us > 16000) {
        delay(us / 1000);  // Convert to milliseconds for longer delays
    } else {
        delayMicroseconds(us);
    }
}
