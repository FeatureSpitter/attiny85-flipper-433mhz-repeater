#include <avr/sleep.h>
#include <avr/pgmspace.h>

// ATtiny85 Default Pin Names
// PB0 - Physical pin 5
// PB1 - Physical pin 6 (LED_BUILTIN)
// PB2 - Physical pin 7 (INT0)
// PB3 - Physical pin 2
// PB4 - Physical pin 3 
// PB5 - Physical pin 1 (RESET, avoid using unless fuse-modified)

// Functional Pin Assignments
#define TX_PIN PB3              // 433MHz Transmitter Data Pin
#define STATUS_LED PB4          // Onboard LED for Transmission Indication
#define SIGNAL_1_BTN PB2        // Emits signal 1 if this pin is LOW
#define SIGNAL_2_BTN PB1        // Emits signal 2 if this pin is LOW
#define SIGNAL_3_BTN PB0        // Emits signal 3 if this pin is LOW

// Signal Data (Stored in Flash to save RAM)
const int16_t signal_data_1[] PROGMEM = {4125,-9928,129,-922,65,-954,197,-98,795,-266,65,-66,131,-300,531,-100,499,-132,99,-100,38515,-9766,163,-1618,161,-98,427,-100,97,-334,397,-100,361,-164,163,-132,199,-66,567,-200,299,-132,227,-100,263,-68,297,-100,4317,-6238,99,-3540,65,-262,65,-730,165,-828,295,-100,99,-134,65,-66,131,-298,395,-130,527,-166,265,-66,199,-134,529,-132,67,-100,891,-100,4651,-10006,195,-98,261,-162,99,-460,689,-166,461,-398,197,-296,197,-100,333,-296,801,-12388,129,-1020,163,-130,161,-164,97,-198,459,-66,589,-98,163,-66,15709,-11116,65,-1484,329,-134,99,-100,201,-100,135,-100,199,-66,169,-336,231,-232,199,-166,229,-132,469,-132,925,-98,11353,-9756,193,-862,363,-232,99,-398,595,-404,65,-234,499,-362,16315,-9788,133,-1084,231,-68,429,-100,131,-168,97,-100,199,-332,431,-100,165,-100,1161,-66,297,-166,6965,-9914,327,-1960,65,-98,197,-100,669,-98,131,-132,131,-132,853,-230,229,-396,1089,-134,4895,-4284,65,-5600,65,-864,163,-300,197,-294,195,-98,361,-130,393,-132,65,-66,197,-98,401,-134,627,-100,461,-68,231,-166,2567,-100,3185,-4504,133,-332,263,-232,131,-332,65,-66,363,-396,267,-100,365,-234,897,-232,163,-100,229,-328,229,-198,1187,-954,4009,-940,713,-914,757,-900,5713,-896,7385,-842,1639,-1648,4121,-21496,727,-1032,2519,-132,1255,-990,701,-968,707,-910,5723,-876,7369,-872,1621,-1670,4097,-21472,751,-1012,2551,-132,1289,-950,717,-960,703,-906,5735,-866,7379,-842,1643,-1644,4129,-21480,561,-3758,1389,-976,673,-990,683,-986,5651,-886,7373,-840,1637,-1670,4111,-21492,633,-3746,1323,-950,727,-932,741,-876,5729,-872,7387,-848,1645,-1656,4107,-21484,667,-3182,1449,-970,701,-940,691,-954,5703,-886,7371,-824,1657,-1642,4133,-21490,727,-1030,3947,-948,729,-932,703,-934,5697,-876,7395,-852,1633,-1646,4113,-7473};
const int16_t signal_data_2[] PROGMEM = {1642,-490,97,-890,65,-632,97,-526,229,-100,1283,-166,699,-98,165,-66,165,-198,765,-2524,265,-134,363,-98,297,-66,393,-164,7729,-7080,65,-66,65,-434,163,-436,263,-98,859,-232,295,-262,195,-622,131,-164,65,-98,195,-724,627,-132,229,-98,457,-100,427,-6998,631,-98,1161,-166,65,-1598,397,-132,331,-298,295,-100,2355,-98,2953,-8214,129,-1450,65,-764,65,-1592,397,-68,397,-134,465,-1890,99,-200,233,-570,295,-100,827,-66,265,-134,331,-66,2719,-8194,97,-366,65,-4994,163,-330,131,-962,165,-298,163,-132,923,-98,495,-98,459,-66,99,-164,391,-166,259,-166,1869,-66,8549,-8076,229,-66,461,-100,593,-98,99,-1480,65,-732,461,-68,529,-66,799,-100,529,-100,7441,-7240,165,-262,129,-492,591,-198,361,-496,65,-166,99,-200,263,-200,65,-990,65,-98,131,-166,195,-102,333,-134,333,-66,889,-134,4921,-13326,197,-168,165,-134,163,-758,99,-164,97,-522,97,-66,459,-166,231,-100,533,-100,429,-98,8311,-8212,729,-496,363,-232,99,-66,163,-134,265,-298,531,-166,331,-132,395,-15992,131,-66,97,-100,361,-330,65,-794,163,-130,97,-1884,363,-66,327,-132,261,-100,327,-132,129,-98,8049,-7252,65,-98,97,-564,959,-332,163,-66,97,-100,263,-130,197,-130,131,-1806,1345,-164,555,-66,4043,-7686,199,-492,165,-7340,429,-130,491,-100,293,-66,163,-198,163,-98,325,-198,163,-132,231,-428,263,-460,459,-66,585,-430,3395,-16412,425,-98,261,-98,99,-198,165,-658,459,-66,165,-196,99,-262,131,-100,197,-164,11549,-3524,65,-4716,331,-198,463,-330,397,-496,165,-132,597,-66,233,-232,195,-68,9809,-6608,99,-132,99,-564,65,-660,197,-66,99,-66,163,-100,65,-66,197,-822,197,-564,65,-66,195,-460,163,-298,199,-166,201,-134,561,-66,263,-98,229,-98,229,-64,1515,-66,5489,-7196,97,-266,197,-562,725,-100,361,-100,231,-168,67,-66,133,-768,97,-166,65,-132,97,-230,7839,-12156,199,-200,99,-166,267,-100,197,-166,263,-630,131,-658,97,-66,595,-166,297,-66,635,-100,3025,-7928,97,-66,99,-1988,97,-5640,265,-264,65,-130,229,-322,199,-1162,161,-164,65,-364,295,-592,491,-66,461,-132,295,-132,2015,-7586,163,-132,131,-198,395,-134,163,-166,231,-200,65,-698,63,-100,197,-164,329,-1000,329,-66,267,-136,333,-134,163,-68,333,-66,401,-8320,165,-66,131,-166,133,-164,561,-200,65,-66,365,-726,65,-132,163,-132,99,-66,97,-98,99,-98,197,-398,329,-134,497,-134,8577,-6522,131,-200,495,-692,165,-66,1027,-500,99,-100,65,-1418,689,-100,6101,-8436,99,-132,97,-1156,63,-66,65,-3674,99,-200,163,-96,163,-360,131,-134,435,-100,665,-98,365,-300,165,-166,195,-100,97,-164,427,-464,591,-166,9321,-5976,99,-394,99,-832,99,-200,65,-268,131,-66,431,-132,133,-66,1259,-230,12245,-3142,2701,-9782,817,-846,4185,-880,819,-854,825,-844,821,-1702,817,-852,851,-1672,845,-3362,851,-3324,873,-826,1671,-856,3363,-18986,687,-160,363,-1128,163,-432,97,-330,199,-974,1553,-948,1585,-908,1633,-878,5019,-900,835,-852,4177,-846,859,-842,813,-852,831,-1710,825,-844,851,-1648,845,-3358,865,-3358,843,-812,1699,-824,3365,-18982,1973,-232,625,-1054,663,-940,1557,-982,1581,-906,763,-1746,5013,-934,795,-872,4179,-850,829,-846,843,-840,819,-1704,839,-844,837,-1672,831,-3362,843,-3350,839,-860,1665,-864,3347,-18972,1953,-266,587,-1066,667,-976,1541,-960,1593,-910,749,-918,799,-876,4175,-944,787,-878,4159,-848,835,-846,839,-854,819,-1702,843,-848,807,-1712,809,-3376,841,-3364,843,-814,1695,-858,3359,-18984,1945,-232,1449,-1860,1553,-950,1587,-942,3281,-900,3319,-924,805,-852,4185,-882,815,-846,827,-844,843,-1680,845,-820,837,-1708,827,-3354,865,-3324,875,-818,1673,-856,3345,-18986,1965,-232,2339,-960,1559,-958,1575,-936,2453,-1740,3321,-914,807,-886,4159,-870,837,-842,825,-842,841,-1678,837,-852,843,-1668,837,-3352,867,-3352,833,-850,1663,-856,3359,-18986,1987,-134,727,-950,3273,-916,1621,-876,793,-886,2471,-906,2465,-942,817,-842,4187,-856,843,-848,805,-854,853,-1672,843,-850,841,-1676,811,-3374,841,-3368,845,-814,1697,-822,3375,-18986,2003,-134,727,-952,729,-942,1593,-916,1613,-912,775,-2568,787,-870,2495,-914,839,-848,4169,-878,803,-852,851,-844,831,-1668,861,-844,815,-1702,839,-3370,843,-3334,855,-844,1669,-852,3355,-5386};
const int16_t signal_data_3[] PROGMEM = {1614,-14340,65,-2518,97,-66,367,-132,195,-130,659,-98,3021,-12232,265,-628,651,-1062,239,-1054,241,-1052,271,-1020,301,-558,767,-958,323,-958,355,-510,803,-478,817,-508,815,-898,379,-912,415,-882,411,-880,405,-452,847,-892,415,-444,873,-452,833,-878,437,-426,873,-860,415,-910,417,-874,413,-870,443,-880,399,-884,425,-888,421,-884,381,-886,421,-906,395,-898,409,-882,419,-884,415,-878,441,-880,399,-458,845,-452,837,-878,439,-442,843,-904,419,-852,419,-446,853,-458,847,-25884,529,-12100,307,-558,753,-982,309,-980,339,-948,333,-954,359,-496,803,-906,383,-914,389,-474,821,-476,845,-434,841,-890,417,-880,415,-878,439,-846,429,-458,843,-888,387,-476,815,-476,843,-862,419,-454,851,-876,415,-880,403,-882,429,-886,421,-884,381,-920,387,-910,399,-892,417,-886,419,-876,413,-876,403,-882,429,-884,425,-890,383,-900,425,-430,871,-444,861,-882,397,-464,843,-900,413,-876,417,-448,837,-450,847,-25984,515,-7884,135,-1604,63,-1264,293,-600,721,-1002,299,-990,303,-1018,307,-984,309,-550,779,-946,341,-946,371,-486,805,-512,809,-482,827,-878,413,-898,417,-878,413,-876,441,-420,871,-884,419,-442,841,-472,843,-886,417,-448,849,-876,407,-884,417,-884,417,-908,413,-880,403,-884,429,-886,423,-884,381,-916,387,-904,409,-874,405,-918,407,-860,419,-882,417,-910,411,-450,839,-458,841,-886,417,-448,853,-874,411,-900,417,-460,839,-454,837,-25980,2597,-914,379,-908,409,-906,409,-906,369,-478,835,-908,411,-880,403,-882,429,-458,841,-888,417,-878,411,-910,399,-894,419,-424,849,-914,419,-878,411,-448,841,-456,839,-486,841,-884,395,-894,409,-880,419,-882,417,-446,851,-884,427,-442,877,-450,845,-882,399,-464,845,-900,413,-874,417,-880,413,-878,441,-880,399,-884,427,-886,423,-884,381,-918,385,-912,397,-898,417,-892,419,-876,413,-880,403,-882,429,-458,845,-452,837,-914,399,-462,841,-866,415,-908,415,-444,853,-448,853,-26000,2585,-912,379,-908,409,-876,437,-874,433,-442,835,-876,443,-876,403,-884,429,-458,849,-888,385,-910,397,-898,407,-886,419,-452,851,-878,417,-908,413,-418,871,-442,873,-450,845,-884,397,-898,419,-890,419,-878,415,-448,839,-882,427,-458,847,-442,865,-876,409,-444,881,-876,409,-880,419,-882,415,-878,443,-880,399,-886,425,-888,419,-868,425,-886,421,-884,413,-886,387,-910,395,-896,409,-902,417,-888,419,-414,867,-452,849,-876,451,-414,867,-876,417,-910,411,-420,871,-460,845,-25948,543,-12118,297,-560,735,-1000,289,-1028,289,-1002,295,-966,335,-558,781,-924,345,-952,379,-486,811,-488,805,-482,841,-882,397,-900,405,-920,383,-886,413,-450,863,-878,405,-454,873,-450,845,-884,397,-464,843,-866,415,-910,415,-872,413,-872,443,-880,401,-884,425,-884,413,-888,387,-910,397,-898,417,-888,419,-874,413,-878,401,-882,427,-886,387,-486,813,-452,845,-908,411,-448,845,-884,419,-878,413,-418,873,-428,871,-25914,497,-12126,273,-598,715,-1020,273,-1016,307,-984,337,-950,331,-524,771,-946,353,-940,389,-474,821,-474,845,-470,811,-926,383,-916,383,-912,407,-874,405,-454,839,-918,381,-484,831,-448,845,-904,407,-466,839,-896,411,-880,417,-880,415,-878,439,-880,397,-886,425,-884,379,-918,387,-908,399,-896,409,-880,417,-882,415,-876,443,-878,401,-880,427,-460,847,-452,831,-882,435,-460,839,-896,385,-884,417,-448,863,-448,867,-25966,2575,-914,411,-878,407,-914,399,-886,423,-432,871,-890,385,-910,397,-894,409,-450,871,-860,419,-882,415,-910,409,-882,401,-456,841,-886,411,-904,411,-446,853,-448,847,-472,843,-866,413,-910,417,-870,413,-904,409,-440,869,-874,411,-442,867,-418,873,-886,423,-450,849,-884,395,-896,417,-892,419,-876,413,-878,405,-912,399,-886,425,-882,413,-888,387,-910,395,-900,407,-884,417,-882,417,-908,411,-880,401,-454,843,-450,875,-882,399,-464,843,-898,381,-910,417,-442,833,-452,879,-25972,527,-7874,101,-1030,299,-560,749,-994,307,-986,309,-1020,305,-950,337,-556,767,-958,355,-910,385,-512,801,-476,817,-472,847,-900,381,-922,383,-912,411,-878,403,-454,875,-882,381,-486,831,-450,875,-870,409,-466,839,-900,407,-892,411,-878,419,-878,415,-878,441,-878,399,-882,429,-884,423,-890,385,-918,381,-918,387,-910,397,-892,409,-898,419,-888,417,-416,867,-450,851,-876,417,-446,867,-876,417,-878,443,-418,885,-450,845,-12302};

const int16_t* selected_signal;
uint16_t signal_length;
uint16_t pointer = 0;

void setup() {
    // Configure Pins
    pinMode(TX_PIN, OUTPUT);
    pinMode(STATUS_LED, OUTPUT);
    pinMode(SIGNAL_1_BTN, INPUT_PULLUP);
    pinMode(SIGNAL_2_BTN, INPUT_PULLUP);
    pinMode(SIGNAL_3_BTN, INPUT_PULLUP);

    // Ensure TX & Antenna are Off
    digitalWrite(TX_PIN, LOW);
    digitalWrite(STATUS_LED, HIGH);

    delay(10); // Give enough time for the tx to power on

    bool signal_selected = false;

    while (!signal_selected) {
        if (digitalRead(SIGNAL_1_BTN) == LOW) {
            selected_signal = signal_data_1;
            signal_length = sizeof(signal_data_1) / sizeof(signal_data_1[0]);

            blink(200, 1);

            signal_selected = true;
        } else if (digitalRead(SIGNAL_2_BTN) == LOW) {
            selected_signal = signal_data_2;
            signal_length = sizeof(signal_data_2) / sizeof(signal_data_2[0]);

            blink(200, 2);

            signal_selected = true;
        } else if (digitalRead(SIGNAL_3_BTN) == LOW) {
            selected_signal = signal_data_3;
            signal_length = sizeof(signal_data_3) / sizeof(signal_data_3[0]);

            blink(200, 3);

            signal_selected = true;
        }
    }

    digitalWrite(STATUS_LED, LOW);
}

void blink(int interval, int times) {
    for (int i = 0; i < times; i++) {
        digitalWrite(STATUS_LED, HIGH);
        delay(interval);
        digitalWrite(STATUS_LED, LOW);
        delay(interval);
    }
}

void loop() {
    // Transmit the signal with LED indication
      int16_t val = pgm_read_word_near(selected_signal + pointer);

      if (++pointer >= signal_length) {
        pointer = 0;  // Reset pointer when end of signal is reached
        digitalWrite(STATUS_LED, LOW);
        delay(3000);
      }

      if (val > 0) {
          digitalWrite(TX_PIN, HIGH);
          digitalWrite(STATUS_LED, HIGH);
      } else {
          digitalWrite(TX_PIN, LOW);
          digitalWrite(STATUS_LED, LOW);
      }

      smartDelay(abs(val));  // Handle long delays properly
}

// Function to handle both short and long delays
void smartDelay(uint16_t us) {
    if (us > 16000) {
        delay(us / 1000);  // Convert to milliseconds for longer delays
    } else {
        delayMicroseconds(us);
    }
}
